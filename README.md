# AMQ Streams custom certificates
AMQStreams example configurations for using custom ceritficates to expose listeners in TLS with mutual authentication two-way.

## Build self signed CA
```bash
make ca-cert
```

## Installing your own CA certificates

For more details read [documentation](https://access.redhat.com/documentation/en-us/red_hat_amq_streams/2.1/html/configuring_amq_streams_on_openshift/security-str#installing-your-own-ca-certificates-str).

Prerequisites:
- A Kafka cluster is not yet deployed.

### Delete existent secrets
```bash
oc delete secret test-cluster-clients-ca-cert
oc delete secret test-cluster-clients-ca
oc delete secret test-cluster-cluster-ca-cert
oc delete secret test-cluster-cluster-ca
```
Ignore any "Not Exists" errors.

### Create new secrets with own CA certificates
```bash
oc create secret generic test-cluster-clients-ca-cert \
  --from-file=ca.crt=ca.crt \
  --from-file=ca.p12=ca.p12 \
  --from-literal=ca.password=123456

oc create secret generic test-cluster-cluster-ca-cert \
  --from-file=ca.crt=ca.crt \
  --from-file=ca.p12=ca.p12 \
  --from-literal=ca.password=123456
```

### Create new secrets with own CA key
```bash
oc create secret generic test-cluster-clients-ca --from-file=ca.key=ca.key
oc create secret generic test-cluster-cluster-ca --from-file=ca.key=ca.key
```

### Add label to secrets
```bash
# Client CA
oc label secret test-cluster-clients-ca-cert strimzi.io/kind=Kafka strimzi.io/cluster=test-cluster
oc label secret test-cluster-clients-ca strimzi.io/kind=Kafka strimzi.io/cluster=test-cluster
# Cluster CA
oc label secret test-cluster-cluster-ca-cert strimzi.io/kind=Kafka strimzi.io/cluster=test-cluster
oc label secret test-cluster-cluster-ca strimzi.io/kind=Kafka strimzi.io/cluster=test-cluster
```

### Add annotation to secrets
```bash
# Client CA
oc annotate secret test-cluster-clients-ca-cert strimzi.io/ca-cert-generation=0
oc annotate secret test-cluster-clients-ca strimzi.io/ca-key-generation=0
# Cluster CA
oc annotate secret test-cluster-cluster-ca-cert strimzi.io/ca-cert-generation=0
oc annotate secret test-cluster-cluster-ca strimzi.io/ca-key-generation=0
```

### Deploy the new cluster with own CA
Edit kafka CR
```yaml
...omit...
spec:
  clientsCa:
    generateCertificateAuthority: false
  clusterCa:
    generateCertificateAuthority: false
...omit...
```

Apply CRs
```bash
oc apply -f cr/kafka.yaml
oc apply -f cr/topic.yaml
oc apply -f cr/user.yaml
```

### Test
Make truststore
```bash
keytool \
  -importcert \
  -deststorepass 123456 \
  -alias ca \
  -file ca.crt \
  -keystore client/truststore.jks \
  -keypass 123456
```
Import CA certificates to verify the server certificates!

Make keystore
```bash
oc get secret test-user -o jsonpath='{.data.user\.p12}' | base64 --decode > user.p12
oc get secret test-user -o jsonpath='{.data.user\.password}' | base64 --decode > user.password

keytool \
    -importkeystore \
    -deststorepass `cat user.password` \
    -destkeystore client/client.jks \
    -srckeystore user.p12 \
    -srcstorepass `cat user.password` \
    -srcstoretype PKCS12
rm user.*
```
Import user certificate and key generated by operator for connecting to brokers!

Generate client.properties
```bash
cat << EOF > client/client.properties
bootstrap.servers=test-cluster-kafka-bootstrap.<namespace>.svc.cluster.local:9093
security.protocol=SSL
ssl.truststore.location=/tmp/client/truststore.jks
ssl.truststore.password=123456
ssl.keystore.location=/tmp/client/client.jks
ssl.keystore.password=`cat user.password`
ssl.key.password=`cat user.password`
EOF
```

Copy test data into pod
```bash
oc rsync client test-cluster-kafka-0:/tmp
```

Verify server certificates
```bash
oc exec -it test-cluster-kafka-0 -- openssl s_client -showcerts -connect test-cluster-kafka-bootstrap.<namespace>.svc.cluster.local:9093

# Output

...omit...
Certificate chain
 0 s:O = io.strimzi, CN = test-cluster-kafka
   i:C = IT, ST = RM, L = Rome, O = redhat.com, OU = Consulting, CN = test-ca
...omit...
 1 s:C = IT, ST = RM, L = Rome, O = redhat.com, OU = Consulting, CN = test-ca
   i:C = IT, ST = RM, L = Rome, O = redhat.com, OU = Consulting, CN = test-ca
...omit...
Acceptable client certificate CA names
C = IT, ST = RM, L = Rome, O = redhat.com, OU = Consulting, CN = test-ca
...omit...
```

Test list topics
```bash
oc exec -it test-cluster-kafka-0 -- /opt/kafka/bin/kafka-topics.sh --bootstrap-server test-cluster-kafka-bootstrap.<namespace>.svc.cluster.local:9093 --command-config /tmp/client/client.properties --list

# Output

test-topic
```

Delete test data from pod
```bash
oc exec -it test-cluster-kafka-0 -- rm -rf /tmp/client
```

## Replacing ceritificates and private key used by your own CA

For more details read [documentation](https://access.redhat.com/documentation/en-us/red_hat_amq_streams/2.1/html/configuring_amq_streams_on_openshift/security-str#proc-replacing-your-own-private-keys-str).

### Disable reconciliation
```bash
oc annotate Kafka test-cluster strimzi.io/pause-reconciliation="true"
```

### Check status
```bash
oc describe Kafka test-cluster
```

### Edit Client CA
oc patch secret test-cluster-clients-ca-cert -p '{"data": {"ca.crt": "'$(base64 ca.crt)'"}}'
oc patch secret test-cluster-clients-ca-cert -p '{"metadata": {"annotations":{"strimzi.io/ca-cert-generation": "1"}}}'

oc patch secret test-cluster-clients-ca -p '{"data": {"ca.key": "'$(base64 ca.key)'"}}'
oc patch secret test-cluster-clients-ca -p '{"metadata": {"annotations":{"strimzi.io/ca-cert-generation": "1"}}}'
```

### Update the cluster with own Client CA
```bash
oc patch --type=merge  Kafka test-cluster -p '{"spec": {"clientsCa":{"generateCertificateAuthority": false}, "clusterCa":{"generateCertificateAuthority": true}}}'
```

Apply CR
```bash
oc apply -f cr/user.yaml
```

### Enable reconciliation
FIXME: remove annotation to CR
```bash
oc annotate Kafka --overwrite test-cluster strimzi.io/pause-reconciliation="false"
```

### Test

Make truststore
```bash
oc get secret test-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 --decode > cluster-ca.crt
oc get secret test-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.password}' | base64 --decode > cluster-ca.password
```

```bash
keytool \
  -importcert \
  -deststorepass `cat cluster-ca.password` \
  -alias ca \
  -file cluster-ca.crt \
  -keystore client/truststore.jks \
  -keypass `cat cluster-ca.password`
rm cluster-ca.*
```
Import CA certificates (Cluster CA) to verify the server certificates!

Make keystore
```bash
oc get secret test-user -o jsonpath='{.data.user\.p12}' | base64 --decode > user.p12
oc get secret test-user -o jsonpath='{.data.user\.password}' | base64 --decode > user.password
```

```bash
keytool \
    -importkeystore \
    -deststorepass `cat user.password` \
    -destkeystore client/client.jks \
    -srckeystore user.p12 \
    -srcstorepass `cat user.password` \
    -srcstoretype PKCS12
rm user.*
```
Import user certificate and key generated by operator for connecting to brokers!

Generate client.properties
```bash
cat << EOF > client/client.properties
bootstrap.servers=test-cluster-kafka-bootstrap.<namespace>.svc.cluster.local:9093
security.protocol=SSL
ssl.truststore.location=/tmp/client/truststore.jks
ssl.truststore.password=`cat ca.password`
ssl.keystore.location=/tmp/client/client.jks
ssl.keystore.password=`cat user.password`
ssl.key.password=`cat user.password`
EOF
```

Copy test data into pod
```bash
oc rsync client test-cluster-kafka-0:/tmp
```

Verify server certificates
```bash
oc exec -it test-cluster-kafka-0 -- openssl s_client -showcerts -connect test-cluster-kafka-bootstrap.<namespace>.svc.cluster.local:9093

# Output

...omit...
---
Certificate chain
 0 s:O = io.strimzi, CN = test-cluster-kafka
   i:O = io.strimzi, CN = cluster-ca v0
...omit...
 1 s:O = io.strimzi, CN = cluster-ca v0
   i:O = io.strimzi, CN = cluster-ca v0
...omit...
Acceptable client certificate CA names
C = IT, ST = RM, L = Rome, O = redhat.com, OU = Consulting, CN = test-ca
...omit...
```

Test list topics
```bash
oc exec -it test-cluster-kafka-0 -- /opt/kafka/bin/kafka-topics.sh --bootstrap-server test-cluster-kafka-bootstrap.<namespace>.svc.cluster.local:9093 --command-config /tmp/client/client.properties --list

# Output

test-topic
```

Delete test data from pod
```bash
oc exec -it test-cluster-kafka-0 -- rm -rf /tmp/client
```
